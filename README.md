## Development

Run the dev server:

```bash
npm run dev
```

Open http://localhost:3000

## Supabase Setup

1) Create a Supabase project and copy the anon key and URL.

2) Create backups table:

```sql
create table if not exists public.backups (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default now(),
  payload jsonb not null
);
alter table public.backups enable row level security;
create policy "allow anon insert" on public.backups for insert with check (true);
create policy "allow anon select" on public.backups for select using (true);
```

3) Environment variables (local and Vercel):

```bash
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
```

In Settings tab, use the backup/restore buttons to sync data.

## Full SQL schema

```sql
-- Settings (per owner)
create table if not exists public.settings (
  owner_id uuid primary key references auth.users(id) on delete cascade,
  base_currency text not null check (base_currency in ('JOD','ILS')),
  jod_to_ils_rate numeric not null default 5,
  updated_at timestamptz default now()
);

-- Units
create table if not exists public.units (
  id text primary key,
  owner_id uuid not null references auth.users(id) on delete cascade,
  name text not null,
  kind text not null check (kind in ('apartment','shop')),
  rent_amount numeric not null,
  rent_currency text not null check (rent_currency in ('JOD','ILS'))
);

-- Tenants
create table if not exists public.tenants (
  id text primary key,
  owner_id uuid not null references auth.users(id) on delete cascade,
  name text not null,
  phone text,
  unit_id text not null references public.units(id) on delete cascade,
  start_date date not null,
  active boolean not null default true
);

-- Utilities
create table if not exists public.utilities (
  id text primary key,
  owner_id uuid not null references auth.users(id) on delete cascade,
  unit_id text not null references public.units(id) on delete cascade,
  period text not null,
  type text not null check (type in ('water','electricity')),
  amount numeric not null,
  currency text not null check (currency in ('JOD','ILS'))
);

-- Invoices
create table if not exists public.invoices (
  id text primary key,
  owner_id uuid not null references auth.users(id) on delete cascade,
  unit_id text not null references public.units(id) on delete cascade,
  tenant_id text not null references public.tenants(id) on delete cascade,
  period text not null,
  scope text not null check (scope in ('monthly','yearly')),
  rent_base numeric not null,
  utilities_base numeric not null,
  total_base numeric not null,
  constraint unique_invoice unique (owner_id, tenant_id, unit_id, period, scope)
);

-- Payments
create table if not exists public.payments (
  id text primary key,
  owner_id uuid not null references auth.users(id) on delete cascade,
  tenant_id text not null references public.tenants(id) on delete cascade,
  unit_id text not null references public.units(id) on delete cascade,
  date date not null,
  amount numeric not null,
  currency text not null check (currency in ('JOD','ILS')),
  period text,
  note text
);

-- RLS (owner only)
alter table public.settings enable row level security;
alter table public.units enable row level security;
alter table public.tenants enable row level security;
alter table public.utilities enable row level security;
alter table public.invoices enable row level security;
alter table public.payments enable row level security;

create policy "owner_select_settings" on public.settings for select using (auth.uid() = owner_id);
create policy "owner_upsert_settings" on public.settings for insert with check (auth.uid() = owner_id);
create policy "owner_update_settings" on public.settings for update using (auth.uid() = owner_id);

create policy "owner_all_units" on public.units for all using (auth.uid() = owner_id) with check (auth.uid() = owner_id);
create policy "owner_all_tenants" on public.tenants for all using (auth.uid() = owner_id) with check (auth.uid() = owner_id);
create policy "owner_all_utilities" on public.utilities for all using (auth.uid() = owner_id) with check (auth.uid() = owner_id);
create policy "owner_all_invoices" on public.invoices for all using (auth.uid() = owner_id) with check (auth.uid() = owner_id);
create policy "owner_all_payments" on public.payments for all using (auth.uid() = owner_id) with check (auth.uid() = owner_id);
```

### Vercel Cron (تحديث يومي لسعر الصرف)

1) من لوحة Vercel > Project > Settings > Cron Jobs: أضف Job يومي `GET /api/rates` (UTC 00:00 مثلاً).
2) تأكد من تهيئة متغير البيئة `NEXT_PUBLIC_CURRENCYAPI_KEY` في Vercel.
3) الواجهة تحدث `settings` حال فتحها بعد تسجيل الدخول، ويمكنك لاحقاً تحويل النداء ليتم حفظه server-side باسم مالك محدد حسب احتياجك.
